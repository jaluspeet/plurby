@model Plurby.Web.Features.Home.EmployeeHistoryViewModel
@using Plurby.Web.Areas
@using System.Linq
@using Plurby.Services.Shared
@using Plurby.Web.Infrastructure
@{
    @functions {
        public string GetRowClass(WorkHistoryDTO entry)
        {
            if (entry.HasPendingProposal) return "table-warning";
            if (entry.IsNewEntryProposal) return "table-info";
            return "";
        }
    }
    
    var identitaCorrente = ViewData[IdentitaViewModel.VIEWDATA_IDENTITACORRENTE_KEY] as IdentitaViewModel;
    var userName = (identitaCorrente?.FirstName != null && identitaCorrente?.LastName != null) 
        ? $"{identitaCorrente.FirstName} {identitaCorrente.LastName}" 
        : "Mio";
    ViewData["Title"] = $"Storico lavorativo di {userName}";
    
    // Raggruppa le voci di lavoro per mese
    var groupedHistory = Model.History
        .GroupBy(e => new { e.StartTime.Year, e.StartTime.Month })
        .OrderByDescending(g => g.Key.Year)
        .ThenByDescending(g => g.Key.Month)
        .ToList();
    
    var currentMonth = DateTime.Now.Year * 100 + DateTime.Now.Month;
    var selectedMonth = Context.Request.Query["month"].FirstOrDefault();
    int monthFilter = string.IsNullOrEmpty(selectedMonth) ? currentMonth : int.Parse(selectedMonth);
    
    // Calcola le voci del mese selezionato
    var selectedMonthEntries = Model.History
        .Where(e => e.StartTime.Year * 100 + e.StartTime.Month == monthFilter)
        .OrderByDescending(e => e.StartTime)
        .ToList();
    
    // Raggruppa per giorno
    var groupedByDay = selectedMonthEntries
        .GroupBy(e => e.StartTime.Date)
        .OrderByDescending(g => g.Key)
        .ToList();
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h2 class="me-3">Storico lavorativo di @userName</h2>

            <!-- Selettore mese moderno con icone e frecce -->
            <div class="btn-group">
                <!-- Bottone mese precedente -->
                <button type="button" class="btn text-white d-flex align-items-center justify-content-center"
                        id="prevMonth" title="Mese precedente"
                        style="background-color:#2A4494; font-size:1.5rem; padding:0.5rem 1rem;">
                    <i class="bi bi-arrow-left-circle"></i>
                </button>

                <!-- Bottone mese corrente con dropdown -->
                <button type="button" class="btn text-white dropdown-toggle d-flex align-items-center justify-content-between"
                        data-bs-toggle="dropdown" id="currentMonthBtn"
                        style="background-color:#2A4494; font-size:1rem; padding:0.5rem 1rem; min-width:220px;">
                    <i class="bi bi-calendar3 me-2"></i>
                    @{
                        var displayDate = new DateTime(monthFilter / 100, monthFilter % 100, 1);
                    }
                    <span>@displayDate.ToString("MMMM yyyy")</span>
                    <i class="bi bi-chevron-down ms-2"></i>
                </button>

                <!-- Dropdown mesi -->
                <ul class="dropdown-menu" id="monthDropdown">
                    @foreach (var group in groupedHistory)
                    {
                        var monthValue = group.Key.Year * 100 + group.Key.Month;
                        var monthDate = new DateTime(group.Key.Year, group.Key.Month, 1);
                        <li>
                            <a class="dropdown-item @(monthValue == monthFilter ? "active" : "")"
                               href="#" data-month="@monthValue">
                                @monthDate.ToString("MMMM yyyy")
                            </a>
                        </li>
                    }
                </ul>

                <!-- Bottone mese successivo -->
                <button type="button" class="btn text-white d-flex align-items-center justify-content-center"
                        id="nextMonth" title="Mese successivo"
                        style="background-color:#2A4494; font-size:1.5rem; padding:0.5rem 1rem;">
                    <i class="bi bi-arrow-right-circle"></i>
                </button>
            </div>
        </div>


        
        @if (ViewData["IsEmployee"] as bool? == true)
        {
            <button type="button" class="btn btn-success d-flex align-items-center" onclick="openAddEntryModal()">
                <i class="bi bi-plus-circle me-2"></i>
                Aggiungi voce
            </button>
        }
    </div>

    <!-- Error message display -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    </div>

    <!-- Voci di lavoro raggruppate per giorno -->
    @if (selectedMonthEntries.Any())
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                Lavoro - @(new DateTime(monthFilter / 100, monthFilter % 100, 1).ToString("MMMM yyyy"))
            </h5>
        </div>

        @foreach (var dayGroup in groupedByDay)
        {
            var dayTotalHours = dayGroup.Where(e => e.Duration.HasValue).Sum(e => e.Duration.Value.TotalHours);
            
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-calendar3 me-2"></i>
                        @dayGroup.Key.ToString("dddd d MMMM yyyy")
                        <span class="badge bg-primary ms-2">@TimeFormatter.FormatItalian(TimeSpan.FromHours(dayTotalHours))</span>
                    </h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Inizio</th>
                                <th>Fine</th>
                                <th>Durata</th>
                                @if (ViewData["IsEmployee"] as bool? == true)
                                {
                                    <th>Azioni</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in dayGroup.OrderByDescending(e => e.StartTime))
                            {
                                <tr class="@GetRowClass(entry)">
                                    <td>
                                        @entry.StartTime.ToLocalTime().ToString("HH:mm")
                                        @if (entry.IsNewEntryProposal)
                                        {
                                            <span class="badge bg-info ms-2">
                                                <i class="bi bi-plus-circle"></i> Nuova
                                            </span>
                                        }
                                    </td>
                                    <td>@(entry.EndTime.HasValue ? entry.EndTime.Value.ToLocalTime().ToString("HH:mm") : "-")</td>
                                    <td>@TimeFormatter.FormatItalian(entry.Duration)</td>
                                    @if (ViewData["IsEmployee"] as bool? == true)
                                    {
                                        <td>
                                            @if (entry.IsNewEntryProposal)
                                            {
                                                <span class="badge bg-warning text-dark me-2">
                                                    <i class="bi bi-clock-history"></i> In attesa
                                                </span>
                                                <button type="button" class="btn btn-sm btn-warning" onclick="openEditNewProposalModal('@entry.ProposalId', '@entry.StartTime.ToLocalTime().ToString("yyyy-MM-ddTHH:mm")', '@(entry.EndTime.HasValue ? entry.EndTime.Value.ToLocalTime().ToString("yyyy-MM-ddTHH:mm") : "")')">
                                                    <i class="bi bi-pencil"></i> Modifica
                                                </button>
                                            }
                                            else if (entry.HasPendingProposal)
                                            {
                                                <span class="badge bg-warning text-dark me-2">
                                                    <i class="bi bi-clock-history"></i> In attesa
                                                </span>
                                                <button type="button" class="btn btn-sm btn-info" onclick="openProposeModal('@entry.Id', '@entry.StartTime.ToLocalTime().ToString("yyyy-MM-ddTHH:mm")', '@entry.EndTime.Value.ToLocalTime().ToString("yyyy-MM-ddTHH:mm")')">
                                                    <i class="bi bi-pencil"></i> Modifica
                                                </button>
                                            }
                                            else if (entry.EndTime.HasValue)
                                            {
                                                <button type="button" class="btn btn-sm btn-info" onclick="openProposeModal('@entry.Id', '@entry.StartTime.ToLocalTime().ToString("yyyy-MM-ddTHH:mm")', '@entry.EndTime.Value.ToLocalTime().ToString("yyyy-MM-ddTHH:mm")')">
                                                    <i class="bi bi-pencil"></i> Proponi
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Nessuna voce di lavoro per @(new DateTime(monthFilter / 100, monthFilter % 100, 1).ToString("MMMM yyyy")).
        </div>
    }
</div>

<!-- Modal per proporre modifica work entry -->
@if (ViewData["IsEmployee"] as bool? == true)
{
    <div class="modal fade" id="proposeWorkEntryModal" tabindex="-1" aria-labelledby="proposeWorkEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="proposeWorkEntryModalLabel">Proponi modifica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="proposeWorkEntryForm" method="post" asp-action="ProposeWorkEntryChange" v-on:submit.prevent="submitProposal">
                    <div class="modal-body" id="proposeModalVueApp">
                        <input type="hidden" id="proposeWorkEntryId" name="workEntryId" />
                        <input type="hidden" id="proposeMonth" name="month" value="@(Context.Request.Query["month"].FirstOrDefault())" />
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Proponi una modifica. Sarà approvata da un manager.
                        </div>
                        
                        <div class="mb-3">
                            <label for="proposeStartTime" class="form-label">Inizio proposto</label>
                            <input type="datetime-local" class="form-control" id="proposeStartTime" name="proposedStartTime" required 
                                   v-model="proposal.startTime" v-on:input="validateDates" 
                                   :class="{'is-invalid': errors.startTime}" />
                            <div class="invalid-feedback" v-if="errors.startTime" v-text="errors.startTime"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="proposeEndTime" class="form-label">Fine proposta</label>
                            <input type="datetime-local" class="form-control" id="proposeEndTime" name="proposedEndTime" required 
                                   v-model="proposal.endTime" v-on:input="validateDates"
                                   :class="{'is-invalid': errors.endTime}" />
                            <div class="invalid-feedback" v-if="errors.endTime" v-text="errors.endTime"></div>
                        </div>
                        
                        <div class="alert alert-danger" v-if="errors.general" v-text="errors.general"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary" :disabled="!isValid">Invia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal per aggiungere nuova work entry -->
    <div class="modal fade" id="addWorkEntryModal" tabindex="-1" aria-labelledby="addWorkEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWorkEntryModalLabel">Aggiungi voce</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addWorkEntryForm" method="post" asp-action="ProposeNewWorkEntry" v-on:submit.prevent="submitNewEntry">
                    <div class="modal-body" id="addModalVueApp">
                        <input type="hidden" id="addMonth" name="month" value="@(Context.Request.Query["month"].FirstOrDefault())" />
                        <input type="hidden" id="editProposalId" name="editProposalId" />
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Aggiungi una nuova voce. Sarà approvata da un manager.
                        </div>
                        
                        <div class="mb-3">
                            <label for="addStartTime" class="form-label">Ora inizio</label>
                            <input type="datetime-local" class="form-control" id="addStartTime" name="startTime" required 
                                   v-model="newEntry.startTime" v-on:input="validateNewDates" 
                                   :class="{'is-invalid': newEntryErrors.startTime}" />
                            <div class="invalid-feedback" v-if="newEntryErrors.startTime" v-text="newEntryErrors.startTime"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="addEndTime" class="form-label">Ora fine</label>
                            <input type="datetime-local" class="form-control" id="addEndTime" name="endTime" required 
                                   v-model="newEntry.endTime" v-on:input="validateNewDates"
                                   :class="{'is-invalid': newEntryErrors.endTime}" />
                            <div class="invalid-feedback" v-if="newEntryErrors.endTime" v-text="newEntryErrors.endTime"></div>
                        </div>
                        
                        <div class="alert alert-danger" v-if="newEntryErrors.general" v-text="newEntryErrors.general"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-success" :disabled="!isNewEntryValid">Invia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script>
        // Global variables for Vue apps
        let proposeVueApp = null;
        let addVueApp = null;

        // Global function accessible to onclick handlers
        function openProposeModal(workEntryId, startTime, endTime) {
            document.getElementById('proposeWorkEntryId').value = workEntryId;
            document.getElementById('proposeStartTime').value = startTime;
            document.getElementById('proposeEndTime').value = endTime;
            
            // Initialize Vue app if not already done
            if (!proposeVueApp) {
                proposeVueApp = new Vue({
                    el: '#proposeModalVueApp',
                    data: {
                        proposal: {
                            startTime: startTime,
                            endTime: endTime
                        },
                        errors: {
                            startTime: '',
                            endTime: '',
                            general: ''
                        }
                    },
                    computed: {
                        isValid() {
                            return this.proposal.startTime && 
                                   this.proposal.endTime && 
                                   !this.errors.startTime && 
                                   !this.errors.endTime && 
                                   !this.errors.general;
                        }
                    },
                    methods: {
                        validateDates() {
                            this.errors.startTime = '';
                            this.errors.endTime = '';
                            this.errors.general = '';
                            
                            // Get values from inputs
                            const startInput = document.getElementById('proposeStartTime');
                            const endInput = document.getElementById('proposeEndTime');
                            
                            if (!startInput.value) {
                                this.errors.startTime = "L'ora di inizio è obbligatoria";
                                return;
                            }
                            
                            if (!endInput.value) {
                                this.errors.endTime = "L'ora di fine è obbligatoria";
                                return;
                            }
                            
                            const startDate = new Date(startInput.value);
                            const endDate = new Date(endInput.value);
                            
                            // Check if dates are valid
                            if (isNaN(startDate.getTime())) {
                                this.errors.startTime = "Data di inizio non valida";
                                return;
                            }
                            
                            if (isNaN(endDate.getTime())) {
                                this.errors.endTime = "Data di fine non valida";
                                return;
                            }
                            
                            // Check if start date is in the future
                            if (startDate > new Date()) {
                                this.errors.startTime = "L'ora di inizio non può essere nel futuro";
                                return;
                            }
                            
                            // Check if end date is before start date
                            if (startDate >= endDate) {
                                this.errors.endTime = "L'ora di fine deve essere successiva all'ora di inizio";
                                return;
                            }
                        },
                        
                        submitProposal() {
                            this.validateDates();
                            if (this.isValid) {
                                // Submit the form
                                document.getElementById('proposeWorkEntryForm').submit();
                            }
                        }
                    },
                    mounted() {
                        // Add event listeners to inputs
                        const startInput = document.getElementById('proposeStartTime');
                        const endInput = document.getElementById('proposeEndTime');
                        
                        if (startInput) {
                            startInput.addEventListener('input', this.validateDates);
                        }
                        
                        if (endInput) {
                            endInput.addEventListener('input', this.validateDates);
                        }
                        
                        // Initial validation
                        this.validateDates();
                    }
                });
            } else {
                // Update existing Vue app with new values
                proposeVueApp.proposal.startTime = startTime;
                proposeVueApp.proposal.endTime = endTime;
                proposeVueApp.validateDates();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('proposeWorkEntryModal'));
            modal.show();
        }

        // Global function for adding new entry
        function openAddEntryModal() {
            // Initialize Vue app if not already done
            if (!addVueApp) {
                addVueApp = new Vue({
                    el: '#addModalVueApp',
                    data: {
                        newEntry: {
                            startTime: '',
                            endTime: ''
                        },
                        newEntryErrors: {
                            startTime: '',
                            endTime: '',
                            general: ''
                        }
                    },
                    computed: {
                        isNewEntryValid() {
                            return this.newEntry.startTime && 
                                   this.newEntry.endTime && 
                                   !this.newEntryErrors.startTime && 
                                   !this.newEntryErrors.endTime && 
                                   !this.newEntryErrors.general;
                        }
                    },
                    methods: {
                        validateNewDates() {
                            this.newEntryErrors.startTime = '';
                            this.newEntryErrors.endTime = '';
                            this.newEntryErrors.general = '';
                            
                            // Get values from inputs
                            const startInput = document.getElementById('addStartTime');
                            const endInput = document.getElementById('addEndTime');
                            
                            if (!startInput.value) {
                                this.newEntryErrors.startTime = "L'ora di inizio è obbligatoria";
                                return;
                            }
                            
                            if (!endInput.value) {
                                this.newEntryErrors.endTime = "L'ora di fine è obbligatoria";
                                return;
                            }
                            
                            const startDate = new Date(startInput.value);
                            const endDate = new Date(endInput.value);
                            
                            // Check if dates are valid
                            if (isNaN(startDate.getTime())) {
                                this.newEntryErrors.startTime = "Data di inizio non valida";
                                return;
                            }
                            
                            if (isNaN(endDate.getTime())) {
                                this.newEntryErrors.endTime = "Data di fine non valida";
                                return;
                            }
                            
                            // Check if start date is in the future
                            if (startDate > new Date()) {
                                this.newEntryErrors.startTime = "L'ora di inizio non può essere nel futuro";
                                return;
                            }
                            
                            // Check if end date is before start date
                            if (startDate >= endDate) {
                                this.newEntryErrors.endTime = "L'ora di fine deve essere successiva all'ora di inizio";
                                return;
                            }
                        },
                        
                        submitNewEntry() {
                            this.validateNewDates();
                            if (this.isNewEntryValid) {
                                // Set proposal ID if editing
                                if (window.editingNewProposalId) {
                                    document.getElementById('editProposalId').value = window.editingNewProposalId;
                                    // Change form action to edit existing proposal
                                    document.getElementById('addWorkEntryForm').setAttribute('action', '/Home/EditNewProposal');
                                } else {
                                    document.getElementById('editProposalId').value = '';
                                    // Reset form action
                                    document.getElementById('addWorkEntryForm').setAttribute('action', '/Home/ProposeNewWorkEntry');
                                }
                                
                                // Submit the form
                                document.getElementById('addWorkEntryForm').submit();
                            }
                        }
                    },
                    mounted() {
                        // Add event listeners to inputs
                        const startInput = document.getElementById('addStartTime');
                        const endInput = document.getElementById('addEndTime');
                        
                        if (startInput) {
                            startInput.addEventListener('input', this.validateNewDates);
                        }
                        
                        if (endInput) {
                            endInput.addEventListener('input', this.validateNewDates);
                        }
                    }
                });
            } else {
                // Reset form
                addVueApp.newEntry.startTime = '';
                addVueApp.newEntry.endTime = '';
                addVueApp.validateNewDates();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addWorkEntryModal'));
            modal.show();
        }

        // Global function for editing new entry proposals
        function openEditNewProposalModal(proposalId, startTime, endTime) {
            // For new entry proposals, we'll reuse the add modal but pre-fill with existing data
            // Set a flag to indicate we're editing
            window.editingNewProposalId = proposalId;
            
            if (!addVueApp) {
                openAddEntryModal(); // This will create the Vue app
            }
            
            // Pre-fill the form
            addVueApp.newEntry.startTime = startTime;
            addVueApp.newEntry.endTime = endTime;
            addVueApp.validateNewDates();
            
            // Update modal title and button
            const modalTitle = document.querySelector('#addWorkEntryModalLabel');
            const submitButton = document.querySelector('#addModalVueApp .btn-success');
            
            if (modalTitle) modalTitle.textContent = 'Modifica Proposta Nuova Voce';
            if (submitButton) {
                submitButton.textContent = 'Aggiorna proposta';
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-warning');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addWorkEntryModal'));
            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Funzionalità selettore mese
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const monthDropdownItems = document.querySelectorAll('#monthDropdown .dropdown-item');
            
            function navigateMonth(direction) {
                const urlParams = new URLSearchParams(window.location.search);
                const currentMonth = parseInt(urlParams.get('month') || '@(DateTime.Now.Year * 100 + DateTime.Now.Month)');
                
                let newYear = Math.floor(currentMonth / 100);
                let newMonth = currentMonth % 100;
                
                if (direction === 'prev') {
                    newMonth--;
                    if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                } else {
                    newMonth++;
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    }
                }
                
                const newMonthValue = newYear * 100 + newMonth;
                urlParams.set('month', newMonthValue);
                window.location.search = urlParams.toString();
            }
            
            prevMonthBtn.addEventListener('click', () => navigateMonth('prev'));
            nextMonthBtn.addEventListener('click', () => navigateMonth('next'));
            
            monthDropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const monthValue = this.getAttribute('data-month');
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('month', monthValue);
                    window.location.search = urlParams.toString();
                });
            });
        });
    </script>
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
